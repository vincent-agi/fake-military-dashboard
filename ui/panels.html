<!DOCTYPE html>
<html>
<head>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-black text-green-400 font-mono text-xs p-2 h-screen overflow-hidden">

<div class="border-2 border-green-600 p-2 mb-2 bg-gray-950">
  <div class="text-sm tracking-widest text-green-500 border-b border-green-600 pb-1 mb-1">╔═ DEFENSE READINESS ═╗</div>
  <div class="flex items-center justify-between">
    <div class="text-lg tracking-widest">DEFCON</div>
    <div id="defcon" class="text-5xl text-green-400 font-bold tabular-nums">5</div>
  </div>
</div>

<div class="border-2 border-green-600 p-2 mb-2 bg-gray-950 overflow-hidden">
  <div class="text-sm tracking-widest text-green-500 border-b border-green-600 pb-1 mb-1">╔═ CONTACT TRACKING ═╗</div>

  <div class="overflow-y-auto" style="max-height: 180px;">
    <table class="w-full text-left text-[10px]">
      <thead class="border-b border-green-600 sticky top-0 bg-gray-950">
        <tr class="text-green-500">
          <th class="pb-1">ID</th>
          <th class="pb-1">TYPE</th>
          <th class="pb-1">DIST</th>
          <th class="pb-1">SPD</th>
          <th class="pb-1">BRG</th>
          <th class="pb-1">STAT</th>
        </tr>
      </thead>
      <tbody id="targets"></tbody>
    </table>
  </div>
</div>

<div class="border-2 border-green-600 p-2 mb-2 bg-gray-950">
  <div class="text-sm tracking-widest text-green-500 border-b border-green-600 pb-1 mb-1">╔═ RF SPECTRUM ANALYSIS ═╗</div>
  <canvas id="spectrum" width="280" height="100"></canvas>
</div>

<div class="border-2 border-green-600 p-2 flex-1 bg-gray-950 overflow-hidden flex flex-col">
  <div class="text-sm tracking-widest text-green-500 border-b border-green-600 pb-1 mb-2">╔═ TACTICAL AI FEED ═╗</div>
  <div id="feed" class="flex-1 overflow-y-auto space-y-1 text-[10px]"></div>
</div>

<script type="module">
import { on } from "../core/bus.js";

let state = { targets:[], defcon:5 };
let signals = [];

const targetsEl = document.getElementById("targets");
const defconEl = document.getElementById("defcon");
const feedEl = document.getElementById("feed");

const spec = document.getElementById("spectrum");
const sctx = spec.getContext("2d");

on("state:update", s => {
  state = s;
});

on("signals:update", s => {
  signals = s;
});

on("ai:message", msg => {
  const time = new Date().toLocaleTimeString();
  feedEl.innerHTML = `<div class="text-cyan-400">[${time}] ${msg}</div>` + feedEl.innerHTML;
  
  // Limiter à 50 messages maximum
  const messages = feedEl.children;
  while (messages.length > 50) {
    feedEl.removeChild(messages[messages.length - 1]);
  }
});

function drawSpectrum(){
  sctx.fillStyle="black";
  sctx.fillRect(0,0,280,120);

  signals.forEach(s=>{
    const x = (s.freq/2500)*280;
    const h = s.power*120;

    sctx.fillStyle = s.band=="DRONE"?"red":s.band=="WIFI"?"cyan":"yellow";
    sctx.fillRect(x,120-h,4,h);
  });

  requestAnimationFrame(drawSpectrum);
}
drawSpectrum();

function render() {
  defconEl.innerText = state.defcon;
  targetsEl.innerHTML = "";

  state.targets.forEach(t => {
    const deg = ((t.a*180/Math.PI)+360)%360;
    const dist = Math.floor(t.r*100);
    const spd = Math.abs(t.vr*10000).toFixed(0);

    targetsEl.innerHTML += `
      <tr class="${t.hostile?'text-red-400 font-bold':'text-green-400'}">
        <td class="py-0.5">${t.id}</td>
        <td class="py-0.5">${t.hostile?'HOSTILE':'FRIEND'}</td>
        <td class="py-0.5">${dist}km</td>
        <td class="py-0.5">${spd}</td>
        <td class="py-0.5">${deg.toFixed(0)}°</td>
        <td class="py-0.5">${t.locked?'<span class="text-yellow-400">LOCK</span>':'TRK'}</td>
      </tr>
    `;
  });

  requestAnimationFrame(render);
}
render();
</script>
</body>
</html>
